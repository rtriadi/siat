---
phase: 05-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/schema.sql
  - database/patches/05-notifications.sql
  - application/models/Notification_model.php
  - application/models/Request_model.php
  - application/models/Stock_model.php
autonomous: true
must_haves:
  truths:
    - "Admin receives in-app notification when a new request is submitted"
    - "Pegawai receives in-app notification when their request is approved, rejected, or delivered"
    - "Admin receives in-app notification when stock falls below threshold"
  artifacts:
    - path: "database/schema.sql"
      provides: "notification table definition"
      contains: "CREATE TABLE IF NOT EXISTS notification"
    - path: "application/models/Notification_model.php"
      provides: "notification CRUD helpers"
      exports: ["create_for_user", "create_for_users", "get_by_user", "mark_read"]
    - path: "application/models/Request_model.php"
      provides: "request lifecycle transitions that emit notifications"
      contains: "approve_request"
    - path: "application/models/Stock_model.php"
      provides: "low-stock checks that emit notifications"
      contains: "low_stock_threshold"
  key_links:
    - from: "application/models/Request_model.php"
      to: "application/models/Notification_model.php"
      via: "create_for_users/create_for_user"
      pattern: "Notification_model"
    - from: "application/models/Stock_model.php"
      to: "application/models/Notification_model.php"
      via: "create_for_users"
      pattern: "Notification_model"
---

<objective>
Create the notification data layer and request-triggered notifications so admins and pegawai receive in-app status updates.

Purpose: Establish foundational notification storage and ensure request lifecycle events emit notifications.
Output: Notification table + model and request lifecycle emits for create/approve/reject/deliver.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@application/models/Request_model.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification table to schema + patch</name>
  <files>database/schema.sql, database/patches/05-notifications.sql</files>
  <action>
Add a new `notification` table with fields:
- id_notification (PK, auto increment)
- user_id (FK -> user.id_user)
- title (varchar 150)
- message (text)
- type enum('request','stock')
- source_id (int, nullable)
- is_read (tinyint default 0)
- created_at (timestamp default current_timestamp)
- read_at (timestamp null)

Indexes: user_id, is_read, created_at, type. Foreign key to user with ON DELETE CASCADE.
Update database/schema.sql and create an idempotent patch in database/patches/05-notifications.sql.
  </action>
  <verify>Check database/schema.sql and database/patches/05-notifications.sql contain the notification table definition.</verify>
  <done>Notification table exists in schema with required columns, indexes, and FK.</done>
</task>

<task type="auto">
  <name>Task 2: Add Notification_model and emit request notifications</name>
  <files>application/models/Notification_model.php, application/models/Request_model.php, application/models/Stock_model.php</files>
  <action>
Create Notification_model with helpers:
- create_for_user($user_id, $title, $message, $type, $source_id = null)
- create_for_users(array $user_ids, ...)
- get_by_user($user_id, $limit = 50)
- mark_read($id_notification, $user_id)

Update Request_model to emit notifications inside the same transaction:
- create_request(): after request header/items insert, notify all admin users (user.level = 1, is_active = 1) with title "Permintaan baru" and message containing request_no; type 'request', source_id = request_id.
- approve_request(): notify request user with title "Permintaan disetujui".
- reject_request(): notify request user with title "Permintaan ditolak".
- deliver_request(): notify request user with title "Permintaan dikirim".

Update Stock_model to emit low-stock notifications to admins when available_qty <= low_stock_threshold after any stock change. Apply checks in:
- adjust_stock()
- reserve_stock()
- restock_batch() (only for items that become low after update)
- release_reserved_stock() and deliver_stock() (when available_qty changes or reserved release increases available)
Notification title "Stok menipis" and message containing item_name, available_qty, threshold; type 'stock', source_id = id_item.

Use Notification_model helpers; if notification insert fails, rollback and return error.
  </action>
  <verify>php -l application/models/Notification_model.php application/models/Request_model.php application/models/Stock_model.php</verify>
  <done>Request lifecycle and low-stock events create in-app notifications for admins/pegawai.</done>
</task>

</tasks>

<verification>
- Notification table defined in schema and patch file
- php -l passes for new/modified PHP files
</verification>

<success_criteria>
- Admin users receive stored notifications for new requests
- Request owners receive stored notifications for approval/rejection/delivery
</success_criteria>

<output>
After completion, create `.planning/phases/05-notifications/05-01-SUMMARY.md`
</output>
