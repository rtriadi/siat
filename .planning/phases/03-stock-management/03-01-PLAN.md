---
phase: 03-stock-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/schema.sql
  - database/patches/03-stock.sql
  - application/models/Stock_model.php
  - application/models/Category_model.php
autonomous: true

must_haves:
  truths:
    - "Stock items store category and three stock states (Available, Reserved, Used)"
    - "Each item has a low stock threshold used for alerts"
    - "Every stock change can be logged as a movement record"
  artifacts:
    - path: database/schema.sql
      provides: "stock_category, stock_item, stock_movement tables"
      contains: "CREATE TABLE IF NOT EXISTS stock_item"
    - path: database/patches/03-stock.sql
      provides: "Idempotent schema patch for stock tables"
    - path: application/models/Stock_model.php
      provides: "Stock CRUD + transactional adjustments + movement logging"
      exports: ["create_item", "update_item", "adjust_stock", "restock_batch"]
    - path: application/models/Category_model.php
      provides: "Category CRUD + lookup list"
      exports: ["get_all", "create", "update"]
  key_links:
    - from: application/models/Stock_model.php
      to: database
      via: "transaction wrapper for adjustments"
      pattern: "trans_start\(|trans_complete\("
    - from: application/models/Stock_model.php
      to: "stock_movement"
      via: "insert movement log"
      pattern: "stock_movement"
---

<objective>
Define stock schema and core data access patterns for categories, items, and stock movement logging with transactional adjustments.

Purpose: Establish the three-state stock model and audit trail foundation used by all stock operations.
Output: Schema patch + Stock/Category models with transaction-safe adjustment methods.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stock-management/03-RESEARCH.md
@database/schema.sql
@application/models/User_model.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stock tables and patch script</name>
  <files>database/schema.sql, database/patches/03-stock.sql</files>
  <action>
Add schema for `stock_category`, `stock_item`, and `stock_movement` to database/schema.sql using InnoDB and utf8mb4. `stock_item` must include `category_id`, `item_name`, `available_qty`, `reserved_qty`, `used_qty`, `low_stock_threshold`, `created_at`, `updated_at`, and enforce a uniqueness constraint on (category_id, item_name). `stock_movement` must log item_id, change type (in/out/adjust), qty delta, reason, user_id, and timestamps with FK to user. Create database/patches/03-stock.sql with idempotent CREATE TABLE IF NOT EXISTS statements and required indexes.
  </action>
  <verify>mysql -u root -p siat_db < database/patches/03-stock.sql && mysql -u root -p -e "SHOW TABLES LIKE 'stock_%'" siat_db</verify>
  <done>Schema contains stock_category, stock_item, and stock_movement tables with required columns and constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Category and Stock models</name>
  <files>application/models/Category_model.php, application/models/Stock_model.php</files>
  <action>
Create Category_model with methods to list, create, and update categories. Create Stock_model with CRUD for items, list with category join, and adjustment helpers that wrap updates in transactions and record stock_movement rows. Include validation guards that prevent available/reserved/used from going negative and treat item identifiers as strings (no numeric coercion). Add restock_batch method to apply multiple item adjustments via update_batch and movement inserts in a single transaction.
  </action>
  <verify>php -l application/models/Category_model.php && php -l application/models/Stock_model.php</verify>
  <done>Models provide category lookup and transaction-safe stock adjustment + movement logging.</done>
</task>

</tasks>

<verification>
- mysql patch script runs without error and tables exist
- php -l passes on new models
</verification>

<success_criteria>
- Stock schema supports three states and low stock threshold per item
- Category and stock models centralize CRUD and adjustments
- Movement log can record all stock changes with user attribution
</success_criteria>

<output>
After completion, create `.planning/phases/03-stock-management/03-01-SUMMARY.md`
</output>
