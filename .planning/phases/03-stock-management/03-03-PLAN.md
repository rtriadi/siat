---
phase: 03-stock-management
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - application/controllers/Stock_import.php
  - application/models/Stock_model.php
  - application/views/stock/import_form.php
  - application/views/stock/import_preview.php
  - application/views/stock/partials/import_table.php
  - application/views/layout/nav.php
autonomous: true

must_haves:
  truths:
    - "Admin can upload Excel restock file and system validates format and quantities"
    - "Admin sees a preview of valid/invalid rows before committing restock"
    - "Admin can download Excel template for restock import"
  artifacts:
    - path: application/controllers/Stock_import.php
      provides: "Import preview, commit, and template download"
      exports: ["import", "import_preview", "import_commit", "download_template"]
    - path: application/views/stock/import_form.php
      provides: "Upload UI and template download link"
    - path: application/views/stock/import_preview.php
      provides: "Preview table with validation errors"
  key_links:
    - from: application/controllers/Stock_import.php
      to: application/models/Stock_model.php
      via: "restock_batch + movement logging"
      pattern: "restock_batch\(|stock_model"
    - from: application/views/stock/import_preview.php
      to: session
      via: "preview rows stored before commit"
      pattern: "import"
---

<objective>
Add Excel restock import with validation, preview-before-commit, and template download.

Purpose: Enable safe bulk restocking that prevents bad data from being committed.
Output: Import controller + views + template download + preview commit flow.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stock-management/03-RESEARCH.md
@.planning/phases/02-authentication--and--user-management/02-04-SUMMARY.md
@application/controllers/User.php
@application/views/user/import_form.php
@application/views/user/import_preview.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Stock_import controller with preview + commit</name>
  <files>application/controllers/Stock_import.php</files>
  <action>
Create Stock_import controller (admin-only) that mirrors the User import flow: upload Excel via CI Upload lib, parse using PhpSpreadsheet, validate columns and quantities, collect row-level errors, and store valid rows in session for preview. Provide import_commit() that reads session rows and calls Stock_model->restock_batch in a transaction, then clears session and shows result. Ensure item identifiers are treated as strings and matching uses item_id from template (fallback to category+name only if ID missing). Include vendor autoload include like User controller.
  </action>
  <verify>php -l application/controllers/Stock_import.php</verify>
  <done>Stock_import handles upload, preview, and commit using session-stored rows.</done>
</task>

<task type="auto">
  <name>Task 2: Build import form, preview UI, and template download</name>
  <files>application/views/stock/import_form.php, application/views/stock/import_preview.php, application/views/stock/partials/import_table.php</files>
  <action>
Create import_form view with upload field and template download button. Create import_preview view showing summary counts and per-row errors in a table partial. Implement download_template() in controller to generate an XLSX file with headers: Item ID, Category, Item Name, Qty, and optional Note. Use PhpSpreadsheet writer and output headers similar to User template download. Keep UI style consistent with AdminLTE and use flash messages for errors.
  </action>
  <verify>php -l application/views/stock/import_form.php && php -l application/views/stock/import_preview.php</verify>
  <done>Admin can access import UI, download template, and preview rows before committing.</done>
</task>

</tasks>

<verification>
- php -l passes for controller and views
- Import preview shows valid/invalid counts and row-level errors
</verification>

<success_criteria>
- Excel import validates format and quantities before commit
- Preview is required prior to saving restock changes
- Template download provides correct columns for restock import
</success_criteria>

<output>
After completion, create `.planning/phases/03-stock-management/03-03-SUMMARY.md`
</output>
