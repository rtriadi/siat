---
phase: 03-stock-management
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - application/controllers/Stock.php
  - application/models/Stock_model.php
  - application/models/Category_model.php
  - application/views/stock/index.php
  - application/views/stock/form.php
  - application/views/stock/partials/stock_table.php
  - application/views/layout/nav.php
autonomous: true

must_haves:
  truths:
    - "Admin can add a new item with category, name, initial quantity"
    - "Admin can edit item details and adjust stock quantities"
    - "Admin sees stock list with Available/Reserved/Used breakdown and low-stock alerts"
  artifacts:
    - path: application/controllers/Stock.php
      provides: "Admin stock CRUD routes and validation"
      exports: ["index", "create", "store", "edit", "update"]
    - path: application/views/stock/index.php
      provides: "Stock list UI with category grouping and alerts"
    - path: application/views/stock/form.php
      provides: "Create/edit form for items"
    - path: application/views/layout/nav.php
      provides: "Navigation link to stock management"
  key_links:
    - from: application/controllers/Stock.php
      to: application/models/Stock_model.php
      via: "create_item/update_item/adjust_stock"
      pattern: "stock_model"
    - from: application/views/stock/index.php
      to: "low_stock_threshold"
      via: "alert badge based on available_qty"
      pattern: "low_stock"
---

<objective>
Deliver admin stock item CRUD UI with category display, stock breakdown, and low-stock alerts.

Purpose: Enable manual stock management and visibility of the three stock states.
Output: Stock controller + views + navigation entry.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stock-management/03-RESEARCH.md
@application/controllers/User.php
@application/views/user/import_form.php
@application/views/user/import_preview.php
@application/views/layout/nav.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stock controller for CRUD and validation</name>
  <files>application/controllers/Stock.php</files>
  <action>
Create Stock controller with admin guards (check_not_login, check_admin). Implement index() to list items with category and stock breakdown. Implement create() + store() flow with form validation (category, item_name, initial available_qty, low_stock_threshold) and use Stock_model to create item with reserved=0, used=0. Implement edit() + update() to change details and adjust quantities via Stock_model transactional method; ensure total states never negative. Use flash messages for success/error. Follow the existing import flow style from User controller.
  </action>
  <verify>php -l application/controllers/Stock.php</verify>
  <done>Stock controller provides admin CRUD with validation and safe quantity adjustments.</done>
</task>

<task type="auto">
  <name>Task 2: Build stock list and form views</name>
  <files>application/views/stock/index.php, application/views/stock/form.php, application/views/stock/partials/stock_table.php</files>
  <action>
Create stock list view with category grouping and table showing item name, available/reserved/used, total, and low-stock alert badge when available_qty < low_stock_threshold. Add action links to edit. Create form view for create/edit with category select, item name, initial available_qty, and low_stock_threshold. Extract table into partial for reuse. Keep AdminLTE layout patterns and use existing template loader.
  </action>
  <verify>php -l application/views/stock/index.php && php -l application/views/stock/form.php</verify>
  <done>Admin can view stock breakdown and access create/edit forms with required fields.</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation link for stock management</name>
  <files>application/views/layout/nav.php</files>
  <action>
Add a Stock Management menu item visible to Admin users linking to Stock controller index. Ensure `$page` comparison for active state follows existing pattern and does not break current nav structure.
  </action>
  <verify>php -l application/views/layout/nav.php</verify>
  <done>Admin sidebar shows Stock Management link with correct active state.</done>
</task>

</tasks>

<verification>
- php -l passes on new controller and views
- Stock list shows three stock states and low-stock alert badge
</verification>

<success_criteria>
- Admin can add/edit items with category, name, initial qty, and threshold
- Stock list displays Available/Reserved/Used breakdown by category
- Low stock alert is based on Available only
</success_criteria>

<output>
After completion, create `.planning/phases/03-stock-management/03-02-SUMMARY.md`
</output>
