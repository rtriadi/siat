---
phase: 04-request-management-workflow
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - application/controllers/Request_admin.php
  - application/views/request_admin/index.php
  - application/views/request_admin/detail.php
  - application/views/request_admin/approve_form.php
  - application/views/request_admin/deliver_form.php
  - application/views/layout/nav.php
autonomous: true

must_haves:
  truths:
    - "Admin can filter and review all requests"
    - "Admin can approve with quantity modification and reserve stock"
    - "Admin can reject with reason"
    - "Admin can deliver with checklist and auto-cancel remainder"
  artifacts:
    - path: "application/controllers/Request_admin.php"
      provides: "admin request list/approve/reject/deliver endpoints"
    - path: "application/views/request_admin/index.php"
      provides: "admin request list with filters"
    - path: "application/views/request_admin/approve_form.php"
      provides: "approval form with quantity modification"
    - path: "application/views/request_admin/deliver_form.php"
      provides: "delivery checklist form"
  key_links:
    - from: "application/controllers/Request_admin.php"
      to: "Request_model"
      via: "approve_request / reject_request / deliver_request"
      pattern: "request_model"
---

<objective>
Implement Admin review, approval, rejection, and delivery workflow with proper stock transitions.

Purpose: Complete request lifecycle management with reservation and delivery tracking.
Output: Admin controller actions, list/approval/delivery views, and navigation link.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-request-management-workflow/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Request_admin controller for admin workflow</name>
  <files>application/controllers/Request_admin.php</files>
  <action>
    - Create Request_admin controller guarded by check_not_login() + check_admin()
    - Implement methods:
      - index(): list all requests with filter (status) and DataTables integration
      - detail($id): show request header + items + status history
      - approve($id): GET shows form, POST validates qty modifications and calls Request_model->approve_request
      - reject($id): POST with reason note calls Request_model->reject_request
      - deliver($id): GET shows checklist (per item delivered qty), POST calls Request_model->deliver_request
    - Use flashdata for success/error messages
    - Enforce status guards before showing approve/deliver actions
  </action>
  <verify>php -l application/controllers/Request_admin.php</verify>
  <done>Admin controller supports list, approve, reject, and deliver actions with guards.</done>
</task>

<task type="auto">
  <name>Task 2: Build admin request list and detail views</name>
  <files>application/views/request_admin/index.php, application/views/request_admin/detail.php</files>
  <action>
    - request_admin/index.php: DataTable list with status filter (pending/approved/delivered/rejected/cancelled)
    - Include action buttons for detail/approve/reject/deliver depending on status
    - request_admin/detail.php: show request meta (pegawai, status, notes, timestamps) and item quantities
  </action>
  <verify>php -l application/views/request_admin/index.php</verify>
  <done>Admin can browse and inspect all requests with status filters.</done>
</task>

<task type="auto">
  <name>Task 3: Build approval + delivery forms and navigation</name>
  <files>application/views/request_admin/approve_form.php, application/views/request_admin/deliver_form.php, application/views/layout/nav.php</files>
  <action>
    - approve_form.php: allow quantity modification (reduce only) + admin note field
    - deliver_form.php: checklist with delivered qty per item; show approved qty and remaining
    - Enforce UI hints for auto-cancel remainder after delivery
    - Add admin sidebar link to Request Management module
  </action>
  <verify>php -l application/views/request_admin/approve_form.php</verify>
  <done>Admin can approve with modified quantities, reject with reason, and deliver via checklist.</done>
</task>

</tasks>

<verification>
- Approve action reserves stock (Available ↓, Reserved ↑) and status becomes approved.
- Deliver action moves Reserved → Used and returns remainder to Available; status becomes delivered.
</verification>

<success_criteria>
- Admin can filter, approve/modify, reject, and deliver requests with correct stock transitions.
</success_criteria>

<output>
After completion, create `.planning/phases/04-request-management-workflow/04-03-SUMMARY.md`
</output>
