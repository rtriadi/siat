---
phase: 04-request-management-workflow
plan: 01
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - database/schema.sql
  - database/patches/04-request.sql
  - application/models/Request_model.php
  - application/models/Stock_model.php
autonomous: true

must_haves:
  truths:
    - "Admin approval reserves stock (Available decreases, Reserved increases)"
    - "Delivered quantities move from Reserved to Used with remainder returned to Available"
    - "Request status transitions enforce pending → approved → delivered/rejected"
  artifacts:
    - path: "database/schema.sql"
      provides: "request tables and stock_movement enum updates"
    - path: "database/patches/04-request.sql"
      provides: "idempotent request schema patch"
    - path: "application/models/Request_model.php"
      provides: "request CRUD + status transition logic"
    - path: "application/models/Stock_model.php"
      provides: "reserve/deliver/cancel stock helpers"
  key_links:
    - from: "application/models/Stock_model.php"
      to: "stock_item"
      via: "transactional arithmetic updates"
      pattern: "set\(.*available_qty.*reserved_qty"
    - from: "application/models/Stock_model.php"
      to: "stock_movement"
      via: "movement log per transition"
      pattern: "insert\('stock_movement'"
---

<objective>
Define request data model and transactional stock/state transitions for approvals, rejections, deliveries, and cancellations.

Purpose: Ensure stock integrity and auditable request lifecycle before any UI flows.
Output: Request tables, model methods for transitions, and stock helper methods.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stock-management/03-01-SUMMARY.md
@.planning/phases/04-request-management-workflow/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add request tables + movement enum update</name>
  <files>database/schema.sql, database/patches/04-request.sql</files>
  <action>
    - Add request header and item tables (e.g., request_header, request_item) with:
      - header: request_no, user_id (pegawai), status (pending/approved/rejected/delivered/cancelled), notes, timestamps per transition
      - items: request_id, item_id, qty_requested, qty_approved, qty_delivered, note
      - foreign keys to user and stock_item
    - Update stock_movement.movement_type enum to include: reserve, deliver, cancel (keep existing in/out/adjust)
    - Create idempotent patch script (04-request.sql) mirroring schema updates
    - Ensure indexes on request status, user_id, created_at for list performance
  </action>
  <verify>mgrep "request_header" database/schema.sql && mgrep "request_item" database/schema.sql && mgrep "movement_type" database/schema.sql</verify>
  <done>Schema defines request tables + updated movement_type enum with idempotent patch.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Request_model transactional transitions</name>
  <files>application/models/Request_model.php</files>
  <action>
    - Create Request_model with methods:
      - create_request($user_id, $items, $note) → inserts header/items status=pending
      - get_by_user($user_id), get_all($filters), get_detail($request_id)
      - approve_request($request_id, $approved_items, $note, $admin_id)
      - reject_request($request_id, $note, $admin_id)
      - cancel_request($request_id, $pegawai_id)
      - deliver_request($request_id, $delivered_items, $admin_id)
    - Enforce allowed status transitions (pending→approved/rejected/cancelled, approved→delivered)
    - Wrap approve/reject/cancel/deliver in CI3 transactions
    - On approval: re-check available stock and reserve using Stock_model helper methods; rollback if any item fails
    - On delivery: call Stock_model helpers to move Reserved→Used and return remainder to Available (auto-cancel), then update status to delivered
    - On cancel: only pending; no stock movement (not reserved yet)
    - On reject: only pending; no stock movement (not reserved yet)
    - Stock_model owns arithmetic updates + stock_movement inserts; Request_model only orchestrates transitions
  </action>
  <verify>php -l application/models/Request_model.php</verify>
  <done>Model supports request lifecycle with transactional stock movements and state guards.</done>
</task>

<task type="auto">
  <name>Task 3: Add stock helper methods for reservation/delivery</name>
  <files>application/models/Stock_model.php</files>
  <action>
    - Add helper methods used by Request_model:
      - reserve_stock($item_id, $qty, $user_id, $reason)
      - deliver_stock($item_id, $qty, $user_id, $reason)
      - release_reserved_stock($item_id, $qty, $user_id, $reason)
    - Each method must use Query Builder arithmetic updates with conditional availability checks and movement log insert
    - Keep existing adjust_stock and restock_batch behavior unchanged
  </action>
  <verify>php -l application/models/Stock_model.php</verify>
  <done>Stock_model exposes reservation/delivery helpers compatible with Request_model transactions.</done>
</task>

</tasks>

<verification>
- Confirm request tables + movement enum exist in schema and patch file.
- Confirm Request_model has transactional transitions and state guards.
</verification>

<success_criteria>
- Request schema and movement enum updates are present and idempotent.
- Request_model enforces status transitions and reserves/delivers stock transactionally.
</success_criteria>

<output>
After completion, create `.planning/phases/04-request-management-workflow/04-01-SUMMARY.md`
</output>
