---
phase: 04-request-management-workflow
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - application/controllers/Request.php
  - application/views/request/form.php
  - application/views/request/index.php
  - application/views/request/detail.php
  - application/views/layout/nav.php
autonomous: true

must_haves:
  truths:
    - "Pegawai can create requests with stock validation"
    - "Pegawai can view list/detail of their own requests"
    - "Pegawai can cancel pending requests before approval"
  artifacts:
    - path: "application/controllers/Request.php"
      provides: "pegawai request create/list/detail/cancel endpoints"
    - path: "application/views/request/form.php"
      provides: "request creation form"
    - path: "application/views/request/index.php"
      provides: "pegawai request list view"
    - path: "application/views/request/detail.php"
      provides: "request detail view"
  key_links:
    - from: "application/controllers/Request.php"
      to: "Request_model"
      via: "create_request + cancel_request"
      pattern: "request_model"
---

<objective>
Implement Pegawai request creation, list, detail, and cancel flows.

Purpose: Enable employees to request items, view status, and manage pending requests.
Output: Pegawai-side controller/actions + views and navigation link.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-request-management-workflow/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Request controller for Pegawai flows</name>
  <files>application/controllers/Request.php</files>
  <action>
    - Create Request controller guarded by check_not_login() + check_pegawai() for Pegawai routes
    - Load Request_model and Stock_model in constructor
    - Implement methods:
      - index(): list own requests with status badges
      - create(): show request form with selectable items (only available_qty > 0)
      - store(): validate selected items/qtys; use Request_model->create_request
      - detail($id): show request header + items; restrict to own request
      - cancel($id): allow cancel only if pending; use Request_model->cancel_request
    - Use Form Validation with callbacks for stock validation (REQ-02) and array inputs via set_data()
    - Use session flashdata for success/error messages
  </action>
  <verify>php -l application/controllers/Request.php</verify>
  <done>Pegawai can create, list, view, and cancel own pending requests.</done>
</task>

<task type="auto">
  <name>Task 2: Build Pegawai request views</name>
  <files>application/views/request/form.php, application/views/request/index.php, application/views/request/detail.php</files>
  <action>
    - request/form.php: list available items with qty inputs; show validation errors inline; include note field
    - request/index.php: table of own requests with status labels and action links (detail, cancel if pending)
    - request/detail.php: show header info (status, notes, timestamps) and items with requested/approved/delivered qty
    - Reuse AdminLTE table styles and consistent layout wrappers
  </action>
  <verify>php -l application/views/request/form.php</verify>
  <done>Pegawai UI supports create/list/detail/cancel with clear status display.</done>
</task>

<task type="auto">
  <name>Task 3: Add Request menu to navigation</name>
  <files>application/views/layout/nav.php</files>
  <action>
    - Add Pegawai sidebar link to Request module (e.g., "Permintaan ATK")
    - Ensure link only visible to Pegawai role
  </action>
  <verify>php -l application/views/layout/nav.php</verify>
  <done>Pegawai can access Request module from navigation.</done>
</task>

</tasks>

<verification>
- Create request with valid quantities succeeds; over-available quantities show validation error.
- Pending request can be cancelled by owner; non-pending cannot.
</verification>

<success_criteria>
- Pegawai can create, view, and cancel their own requests with stock validation.
- List/detail views show request status and item quantities.
</success_criteria>

<output>
After completion, create `.planning/phases/04-request-management-workflow/04-02-SUMMARY.md`
</output>
