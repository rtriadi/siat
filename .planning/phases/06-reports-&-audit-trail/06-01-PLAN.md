---
phase: 06-reports-&-audit-trail
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - application/controllers/Reports.php
  - application/models/Request_model.php
  - application/views/reports/request_history.php
  - application/views/layout/nav.php
autonomous: true

must_haves:
  truths:
    - "Admin can view request history rows showing requester, item, qty, status, and timestamps"
    - "Admin can filter request history by date range, pegawai, and status"
    - "Admin can export the filtered request history to Excel"
  artifacts:
    - path: "application/controllers/Reports.php"
      provides: "Admin request history report page and Excel export action"
    - path: "application/models/Request_model.php"
      provides: "Filtered request history query with joins and date bounds"
    - path: "application/views/reports/request_history.php"
      provides: "Request history filters, table, and export button"
    - path: "application/views/layout/nav.php"
      provides: "Admin navigation links to report pages"
  key_links:
    - from: "application/controllers/Reports.php"
      to: "Request_model::get_request_history_report"
      via: "CI3 model call"
      pattern: "get_request_history_report"
    - from: "application/controllers/Reports.php"
      to: "PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx"
      via: "export_request_history"
      pattern: "php://output"
    - from: "application/views/reports/request_history.php"
      to: "reports/request_history"
      via: "filter form query params"
      pattern: "request_history"
---

<objective>
Request history report with filters and Excel export for admins.

Purpose: Provide REPORT-01/02/07 visibility into request activity with auditable exports.
Output: Report controller action, model query, view with filters + export, and nav entry.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reports-&-audit-trail/06-RESEARCH.md

@application/models/Request_model.php
@application/controllers/Request_admin.php
@application/controllers/Request.php
@application/controllers/User.php
@application/views/layout/nav.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add request history report query in Request_model</name>
  <files>application/models/Request_model.php</files>
  <action>
    Add a `get_request_history_report(array $filters)` method that returns request history rows joined across:
    - request_header (request_no, status, created_at, approved_at/delivered_at)
    - request_item (qty_requested, qty_approved, qty_delivered, note)
    - stock_item (item_name)
    - user (nama, nip, unit)

    Filtering rules:
    - date_start/date_end apply to request_header.created_at with inclusive end-day (use 23:59:59 for end)
    - status filter applies to request_header.status
    - user_id filter applies to request_header.user_id
    - order by request_header.created_at DESC, then request_item.id_request_item ASC

    Ensure all filters are optional; when omitted, return full dataset. Use Query Builder only (no raw SQL).
  </action>
  <verify>php -l application/models/Request_model.php</verify>
  <done>Request_model exposes a reusable filtered query for request history rows.</done>
</task>

<task type="auto">
  <name>Task 2: Build Reports controller for request history + Excel export</name>
  <files>application/controllers/Reports.php</files>
  <action>
    Create `Reports` controller with constructor enforcing `check_not_login()` + `check_admin()`.
    Add methods:
    - `request_history()` renders report view with filters and rows (use Request_model::get_request_history_report).
    - `export_request_history()` uses PhpSpreadsheet to generate XLSX from the same filtered data.

    In `request_history()`, load active pegawai list (level=2, is_active=1) with id_user, nama, nip
    and pass it to the view for the pegawai filter select.

    Export requirements:
    - Reuse filter parsing from request_history (date range, user_id, status).
    - No output before headers; stream via `php://output` and `exit` after save.
    - Include clear column headers: Request No, Tanggal, Pegawai, NIP, Unit, Status, Item, Qty Requested, Qty Approved, Qty Delivered, Notes.

    Load PhpSpreadsheet autoloader similarly to existing import controllers (User/Stock_import).
  </action>
  <verify>php -l application/controllers/Reports.php</verify>
  <done>Admin can hit reports/request_history and reports/export_request_history endpoints without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create request history view + add reports nav links</name>
  <files>application/views/reports/request_history.php, application/views/layout/nav.php</files>
  <action>
    Build request history view with:
    - Filter form (date_start, date_end, pegawai select, status select)
    - Table of rows from controller
    - Export button linking to export_request_history with current query params

    For pegawai select, use user list from controller (active pegawai only) and show Nama + NIP.

    Update admin navigation in nav.php to add a "Laporan Inventori" section (under Inventori) with links:
    - Request History (reports/request_history)
    - Stock Movement (reports/stock_movement)
    - Audit Trail (reports/audit_trail)
    - Stock Levels (reports/stock_levels)

    Ensure active state uses $page matching view titles.
  </action>
  <verify>php -l application/views/reports/request_history.php</verify>
  <done>Request history page renders filters/table and nav includes report links for admins.</done>
</task>

</tasks>

<verification>
- Load /reports/request_history as admin: filters render, table shows results, export downloads XLSX
</verification>

<success_criteria>
- REPORT-01/02/07 satisfied for request history view + filters + Excel export.
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-&-audit-trail/06-01-SUMMARY.md`
</output>
