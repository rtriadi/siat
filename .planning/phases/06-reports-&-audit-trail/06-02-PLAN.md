---
phase: 06-reports-&-audit-trail
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - application/controllers/Reports.php
  - application/models/Stock_model.php
  - application/views/reports/stock_movement.php
  - application/views/reports/audit_trail.php
autonomous: true

must_haves:
  truths:
    - "Admin can view stock movement report with running balance per item"
    - "Admin can filter stock movement by date range, item, and category"
    - "Admin can view audit trail log for stock changes with user, time, action, reason"
    - "Admin can export stock movement report to Excel"
  artifacts:
    - path: "application/controllers/Reports.php"
      provides: "Stock movement + audit trail pages and export action"
    - path: "application/models/Stock_model.php"
      provides: "Movement report query + running balance mapping"
    - path: "application/views/reports/stock_movement.php"
      provides: "Stock movement filters, table, export button"
    - path: "application/views/reports/audit_trail.php"
      provides: "Audit trail filters and table"
  key_links:
    - from: "application/controllers/Reports.php"
      to: "Stock_model::get_stock_movement_report"
      via: "CI3 model call"
      pattern: "get_stock_movement_report"
    - from: "application/controllers/Reports.php"
      to: "Stock_model::get_audit_trail_report"
      via: "CI3 model call"
      pattern: "get_audit_trail_report"
    - from: "application/controllers/Reports.php"
      to: "PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx"
      via: "export_stock_movement"
      pattern: "php://output"
---

<objective>
Stock movement report, audit trail view, and Excel export for admins.

Purpose: Deliver REPORT-03/04/05/06/08 for auditability of stock changes.
Output: Report controller actions, Stock_model queries with running balance, and report views.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reports-&-audit-trail/06-RESEARCH.md

@application/models/Stock_model.php
@application/controllers/Stock.php
@application/controllers/Stock_import.php
@application/views/layout/nav.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stock movement + audit trail queries in Stock_model</name>
  <files>application/models/Stock_model.php</files>
  <action>
    Add methods:
    - `get_stock_movement_report(array $filters)` returning rows joined from stock_movement + stock_item + stock_category + user.
    - `get_audit_trail_report(array $filters)` using the same joins but optimized for audit log (no balance requirement).

    Filters:
    - date_start/date_end (inclusive end-day) on stock_movement.created_at
    - item_id on stock_movement.item_id
    - category_id on stock_item.category_id

    Running balance:
    - Define starting balance per item before applying deltas:
      - If date_start provided, fetch each item's available_qty at the start boundary by
        computing current available_qty minus net movement deltas after date_start (to align with historical balance).
      - If no date_start, derive from earliest movement by starting at 0 and applying all deltas in order.
    - Then compute running balance for available_qty by sorting ASC by created_at, then applying mapping:
      in:+qty, out:-qty, adjust:+qty_delta, reserve:-qty, cancel:+qty, deliver:0
    - Include running_balance in each row (then display in UI/export). Keep audit trail ordered DESC by created_at.

    Use Query Builder only; no raw SQL. Provide safe defaults when filters are empty.
  </action>
  <verify>php -l application/models/Stock_model.php</verify>
  <done>Stock_model can return filtered movement rows with running balance and audit log rows.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Reports controller with stock movement + audit trail + export</name>
  <files>application/controllers/Reports.php</files>
  <action>
    Add actions to Reports controller:
    - `stock_movement()` loads filters, calls Stock_model::get_stock_movement_report, and renders view.
    - `audit_trail()` loads filters, calls Stock_model::get_audit_trail_report, and renders view.
    - `export_stock_movement()` uses PhpSpreadsheet to export movement rows with running balance.

    Provide filter data for views:
    - Item list (id + name) and category list (id + name) for select options.
    - Date range inputs (start/end).

    Export requirements:
    - Same filters as stock_movement()
    - Columns: Tanggal, Item, Kategori, Tipe, Qty, Reason, User, Running Balance
    - Stream via php://output with correct headers; no output before headers; exit after save.
  </action>
  <verify>php -l application/controllers/Reports.php</verify>
  <done>Stock movement and audit trail routes render, and export outputs XLSX.</done>
</task>

<task type="auto">
  <name>Task 3: Build stock movement + audit trail report views</name>
  <files>application/views/reports/stock_movement.php, application/views/reports/audit_trail.php</files>
  <action>
    Create stock_movement view with:
    - Filter form (date_start/date_end, category, item)
    - Export button (preserves query params)
    - Table showing movement rows with running balance column

    Create audit_trail view with:
    - Same filter controls
    - Table showing action, qty, user, timestamp, reason

    Use AdminLTE table styling consistent with existing reports. Show empty-state message if no rows.
  </action>
  <verify>php -l application/views/reports/stock_movement.php</verify>
  <done>Both report views render filters and tables without PHP errors.</done>
</task>

</tasks>

<verification>
- Load /reports/stock_movement and /reports/audit_trail as admin; filters and tables render; export downloads XLSX.
</verification>

<success_criteria>
- REPORT-03/04/05/06/08 satisfied for stock movement and audit trail reporting.
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-&-audit-trail/06-02-SUMMARY.md`
</output>
