---
phase: 06-reports-&-audit-trail
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - application/controllers/Reports.php
  - application/models/Stock_model.php
  - application/views/reports/stock_levels.php
autonomous: true

must_haves:
  truths:
    - "Admin can view current stock levels with Available/Reserved/Used breakdown"
    - "Admin can filter stock levels by category"
    - "Admin can export current stock levels to Excel"
  artifacts:
    - path: "application/controllers/Reports.php"
      provides: "Stock levels page and Excel export action"
    - path: "application/models/Stock_model.php"
      provides: "Stock levels query with category filter"
    - path: "application/views/reports/stock_levels.php"
      provides: "Stock levels filters, table, and export button"
  key_links:
    - from: "application/controllers/Reports.php"
      to: "Stock_model::get_stock_levels_report"
      via: "CI3 model call"
      pattern: "get_stock_levels_report"
    - from: "application/controllers/Reports.php"
      to: "PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx"
      via: "export_stock_levels"
      pattern: "php://output"
---

<objective>
Current stock levels report with category filter and Excel export.

Purpose: Deliver REPORT-09 for snapshot visibility of inventory state.
Output: Stock levels report page + export, model query, view.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reports-&-audit-trail/06-RESEARCH.md

@application/models/Stock_model.php
@application/controllers/Stock.php
@application/views/layout/nav.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stock levels report query in Stock_model</name>
  <files>application/models/Stock_model.php</files>
  <action>
    Add `get_stock_levels_report(array $filters)` method returning stock_item rows joined with stock_category.
    - Include: item_name, category_name, available_qty, reserved_qty, used_qty, low_stock_threshold
    - Optional category_id filter
    - Order by category_name ASC, item_name ASC
  </action>
  <verify>php -l application/models/Stock_model.php</verify>
  <done>Stock_model returns filtered stock level rows ready for report/export.</done>
</task>

<task type="auto">
  <name>Task 2: Add stock levels report + export in Reports controller</name>
  <files>application/controllers/Reports.php</files>
  <action>
    Add `stock_levels()` action to render stock levels view with category filter and rows from Stock_model.
    Add `export_stock_levels()` action using PhpSpreadsheet to export filtered rows.

    Provide category list (id + name) to the stock_levels view for filter options.

    Export requirements:
    - Columns: Category, Item, Available, Reserved, Used, Low Stock Threshold
    - Stream via php://output with correct headers; no output before headers; exit after save.
  </action>
  <verify>php -l application/controllers/Reports.php</verify>
  <done>Stock levels report renders and export downloads XLSX.</done>
</task>

<task type="auto">
  <name>Task 3: Build stock levels report view</name>
  <files>application/views/reports/stock_levels.php</files>
  <action>
    Create stock levels view with:
    - Category filter select (all + categories)
    - Export button preserving query params
    - Table showing Available/Reserved/Used per item
    - Low-stock indicator (badge when available <= threshold)
  </action>
  <verify>php -l application/views/reports/stock_levels.php</verify>
  <done>Stock levels view renders table and export link without errors.</done>
</task>

</tasks>

<verification>
- Load /reports/stock_levels as admin; filter works; export downloads XLSX.
</verification>

<success_criteria>
- REPORT-09 satisfied for stock levels report + Excel export.
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-&-audit-trail/06-03-SUMMARY.md`
</output>
