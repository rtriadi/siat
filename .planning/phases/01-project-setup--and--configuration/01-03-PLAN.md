---
phase: 01-project-setup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - database/schema.sql
autonomous: true

must_haves:
  truths:
    - "Database 'siat_db' exists and is accessible via mysqli"
    - "User table exists with columns for authentication (id_user, username, password, nama, level)"
    - "User role table exists with role definitions (Admin, Pegawai)"
    - "Default admin account exists for initial login"
  artifacts:
    - path: "database/schema.sql"
      provides: "Database schema definition"
      contains: "CREATE TABLE.*user.*CREATE TABLE.*user_role"
      min_lines: 30
  key_links:
    - from: "database/schema.sql"
      to: "siat_db database"
      via: "CREATE DATABASE and CREATE TABLE statements"
      pattern: "CREATE (DATABASE|TABLE)"
    - from: "user table"
      to: "user_role table"
      via: "foreign key level references user_role"
      pattern: "FOREIGN KEY.*REFERENCES user_role"
---

<objective>
Create database schema with base tables for authentication and user management.

Purpose: Initializes the siat_db database with user and user_role tables following the two-role system (Admin for warehouse managers, Pegawai for employees) documented in STATE.md. Creates schema with bcrypt-compatible password column (VARCHAR(255)), proper indexing, and a default admin account for initial access.

Output: Executable SQL schema file and initialized database with user and user_role tables, ready for authentication.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup--and--configuration/01-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema with user authentication tables</name>
  <files>database/schema.sql</files>
  <action>
Create database/schema.sql with schema definition for SIAT authentication system.

1. Create database/ directory if it doesn't exist
2. Create database/schema.sql with the following structure:

```sql
-- SIAT (Sistem Inventori ATK Terpadu) Database Schema
-- Phase 1: Authentication and User Management

-- Create database
CREATE DATABASE IF NOT EXISTS siat_db
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE siat_db;

-- User roles lookup table
CREATE TABLE IF NOT EXISTS user_role (
  id_role INT PRIMARY KEY AUTO_INCREMENT,
  nama_role VARCHAR(50) NOT NULL UNIQUE,
  deskripsi VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Users table
CREATE TABLE IF NOT EXISTS user (
  id_user INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,  -- bcrypt hash (255 for future algorithm changes)
  nama VARCHAR(100) NOT NULL,
  nip VARCHAR(20) UNIQUE,  -- Nomor Induk Pegawai (employee ID)
  level INT NOT NULL,  -- Foreign key to user_role.id_role
  is_active TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  last_login TIMESTAMP NULL,
  
  INDEX idx_username (username),
  INDEX idx_nip (nip),
  INDEX idx_level (level),
  
  FOREIGN KEY (level) REFERENCES user_role(id_role)
    ON DELETE RESTRICT
    ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insert default roles (Admin and Pegawai)
INSERT INTO user_role (id_role, nama_role, deskripsi) VALUES
  (1, 'Admin', 'Administrator - manages warehouse and approves requests'),
  (2, 'Pegawai', 'Employee - can request office supplies')
ON DUPLICATE KEY UPDATE nama_role = VALUES(nama_role);

-- Insert default admin account
-- Username: admin
-- Password: admin123 (bcrypt hash generated with PASSWORD_DEFAULT)
-- Note: Admin should change password after first login
INSERT INTO user (username, password, nama, nip, level) VALUES
  ('admin', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Administrator', '000000', 1)
ON DUPLICATE KEY UPDATE username = VALUES(username);
```

Key design decisions:
- **utf8mb4**: Full Unicode support including emoji (not utf8 which is limited)
- **VARCHAR(255) for password**: Accommodates bcrypt (60 chars) and future algorithms (Argon2, etc.)
- **Unique constraints**: username and NIP must be unique
- **Foreign key**: level references user_role.id_role with RESTRICT on delete (prevent deleting role in use)
- **Indexes**: username, NIP, level for fast lookups during authentication and queries
- **Timestamps**: created_at, updated_at, last_login for audit trail
- **Default admin**: Password is bcrypt hash of "admin123" for initial access

3. Execute schema to create database:
```bash
mysql -u root -p < database/schema.sql
```

If mysql command not available or fails, provide instructions for manual execution via phpMyAdmin or MySQL Workbench.

Note: The bcrypt hash in INSERT statement is pre-generated for "admin123" password. This is safe for initial setup because it's a default password that admin should change after first login.
  </action>
  <verify>
Check schema file created:
```bash
ls -lh database/schema.sql
cat database/schema.sql | grep -E "(CREATE DATABASE|CREATE TABLE|INSERT INTO)"
```

Verify database and tables exist:
```bash
mysql -u root -e "SHOW DATABASES LIKE 'siat_db';"
mysql -u root siat_db -e "SHOW TABLES;"
mysql -u root siat_db -e "DESCRIBE user;"
mysql -u root siat_db -e "DESCRIBE user_role;"
```

Check default data inserted:
```bash
mysql -u root siat_db -e "SELECT id_role, nama_role FROM user_role;"
mysql -u root siat_db -e "SELECT id_user, username, nama, level FROM user;"
```

Expected: siat_db database exists, user and user_role tables exist, user table has VARCHAR(255) password column, default admin account exists with bcrypt password hash.
  </verify>
  <done>
database/schema.sql file exists with CREATE DATABASE, CREATE TABLE statements for user_role and user tables. Database siat_db created and accessible. user_role table has 2 rows (Admin, Pegawai). user table has password column VARCHAR(255), proper indexes on username/nip/level, foreign key to user_role. Default admin account exists (username: admin, bcrypt password hash for "admin123").
  </done>
</task>

</tasks>

<verification>
Overall database setup checks:

1. Database exists and is accessible:
   - siat_db database created
   - Can connect via mysqli driver with credentials from development config
   - Character set is utf8mb4 with utf8mb4_unicode_ci collation

2. Tables created with correct structure:
   - user_role table with id_role, nama_role, deskripsi
   - user table with id_user, username, password (VARCHAR 255), nama, nip, level, timestamps
   - Foreign key relationship: user.level â†’ user_role.id_role
   - Proper indexes on username, nip, level

3. Default data exists:
   - 2 roles: Admin (id_role=1), Pegawai (id_role=2)
   - 1 user: admin account with bcrypt password hash
   - Password column contains bcrypt hash (starts with $2y$)

4. Schema file is reusable:
   - database/schema.sql can be executed multiple times (IF NOT EXISTS, ON DUPLICATE KEY)
   - Can be used to set up fresh environments
</verification>

<success_criteria>
- [ ] database/schema.sql file exists and is executable
- [ ] siat_db database exists with utf8mb4 character set
- [ ] user_role table exists with Admin and Pegawai roles
- [ ] user table exists with bcrypt-compatible password column (VARCHAR 255)
- [ ] Foreign key constraint: user.level references user_role.id_role
- [ ] Indexes exist on user.username, user.nip, user.level
- [ ] Default admin account exists with bcrypt password hash
- [ ] Schema uses utf8mb4 and utf8mb4_unicode_ci throughout
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup--and--configuration/01-03-SUMMARY.md`
</output>
