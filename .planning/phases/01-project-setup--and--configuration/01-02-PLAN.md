---
phase: 01-project-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - application/controllers/Auth.php
  - application/models/User_model.php
autonomous: true

must_haves:
  truths:
    - "User passwords are hashed with bcrypt instead of SHA1"
    - "Existing users with SHA1 passwords can still log in and are automatically migrated to bcrypt"
    - "New user registrations use bcrypt from the start"
    - "Password verification is timing-attack resistant"
  artifacts:
    - path: "application/controllers/Auth.php"
      provides: "Secure authentication with bcrypt password hashing"
      contains: "password_hash.*password_verify"
      min_lines: 50
  key_links:
    - from: "application/controllers/Auth.php"
      to: "password_hash() function"
      via: "registration and password migration"
      pattern: "password_hash\\(.*PASSWORD_DEFAULT\\)"
    - from: "application/controllers/Auth.php"
      to: "password_verify() function"
      via: "login authentication"
      pattern: "password_verify\\("
    - from: "application/controllers/Auth.php"
      to: "SHA1 legacy detection"
      via: "hash length check for migration"
      pattern: "strlen.*===.*40"
---

<objective>
Upgrade password hashing from insecure SHA1 to bcrypt with automatic migration for existing users.

Purpose: Eliminates critical security vulnerability where passwords are stored using cryptographically broken SHA1 hashing. Implements PHP's native password_hash() with bcrypt (PASSWORD_DEFAULT) for new passwords, and provides transparent migration for existing SHA1 hashes via hash-on-login pattern from RESEARCH.md Pattern 4.

Output: Updated Auth.php controller with bcrypt password hashing for new users, SHA1-to-bcrypt migration logic for existing users, and timing-attack resistant password verification.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup--and--configuration/01-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/CONCERNS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade password hashing from SHA1 to bcrypt with migration</name>
  <files>application/controllers/Auth.php</files>
  <action>
Update application/controllers/Auth.php to replace SHA1 password hashing with bcrypt, following RESEARCH.md Pattern 4 (hash-on-login migration).

Current state analysis from CONCERNS.md: Auth.php uses sha1() for password hashing in login verification. This is cryptographically broken and must be replaced.

Changes required:

1. **Login method (user_login)** - Add migration logic:
   - Read current password from database
   - Check if password is SHA1 (strlen === 40) or bcrypt
   - For SHA1 hashes: verify with sha1(), then migrate to bcrypt if correct
   - For bcrypt hashes: verify with password_verify()
   - Use password_needs_rehash() to upgrade cost if needed

2. **Registration/Password creation** (if exists) - Use bcrypt:
   - Replace sha1() with password_hash($password, PASSWORD_DEFAULT)
   - Store resulting hash in database (ensure VARCHAR(255) column size)

Implementation pattern from RESEARCH.md:
```php
// In login method
$password = $this->input->post('password');
$user = $this->user_model->get_by_username($username);

if (!$user) {
    // User doesn't exist
    $this->session->set_flashdata('error', 'Username atau Password salah!');
    redirect('auth/login');
}

// Check if old SHA1 hash (40 characters) or new bcrypt hash
if (strlen($user->password) === 40) {
    // Old SHA1 system - verify and migrate
    if (sha1($password) === $user->password) {
        // Password correct - upgrade to bcrypt
        $new_hash = password_hash($password, PASSWORD_DEFAULT);
        $this->user_model->update_password($user->id_user, $new_hash);
        
        // Log user in (existing session logic)
        $this->session->set_userdata('id_user', $user->id_user);
        // ... rest of login success logic
    } else {
        // Password incorrect
        $this->session->set_flashdata('error', 'Username atau Password salah!');
        redirect('auth/login');
    }
} else {
    // Already using bcrypt
    if (password_verify($password, $user->password)) {
        // Check if hash needs rehashing (cost/algorithm changed)
        if (password_needs_rehash($user->password, PASSWORD_DEFAULT)) {
            $new_hash = password_hash($password, PASSWORD_DEFAULT);
            $this->user_model->update_password($user->id_user, $new_hash);
        }
        
        // Log user in (existing session logic)
        $this->session->set_userdata('id_user', $user->id_user);
        // ... rest of login success logic
    } else {
        // Password incorrect
        $this->session->set_flashdata('error', 'Username atau Password salah!');
        redirect('auth/login');
    }
}
```

3. **Add update_password method to user_model** (if doesn't exist):
Create application/models/User_model.php if missing, or add method:
```php
public function update_password($id_user, $new_password_hash) {
    return $this->db->update('user', 
        array('password' => $new_password_hash), 
        array('id_user' => $id_user)
    );
}
```

Critical: Do NOT use the deprecated `salt` parameter for password_hash(). Let the function generate cryptographically secure salts automatically. Do NOT use custom cost - let PASSWORD_DEFAULT determine it (cost 10 for PHP 8.3.6).

Why this approach: Hash-on-login migration allows existing users to continue logging in without password resets. When they successfully log in with SHA1 hash, their password is immediately upgraded to bcrypt transparently.
  </action>
  <verify>
Check Auth.php contains bcrypt implementation:
```bash
grep -E "(password_hash|password_verify|strlen.*40)" application/controllers/Auth.php
```

Expected output should show:
- password_hash() calls with PASSWORD_DEFAULT
- password_verify() calls for authentication
- strlen check for detecting SHA1 vs bcrypt hashes

Verify user_model has update_password method:
```bash
grep -A5 "function update_password" application/models/User_model.php
```

Test password hash generation (should produce bcrypt hash starting with $2y$):
```bash
php -r "echo password_hash('test123', PASSWORD_DEFAULT);"
```
  </verify>
  <done>
application/controllers/Auth.php contains hash-on-login migration logic: detects SHA1 hashes by strlen === 40, verifies old SHA1 passwords and migrates to bcrypt, uses password_verify() for bcrypt passwords, calls password_needs_rehash() to upgrade hashes when needed. User_model has update_password($id_user, $hash) method. All new password storage uses password_hash() with PASSWORD_DEFAULT (bcrypt).
  </done>
</task>

</tasks>

<verification>
Overall security upgrade checks:

1. SHA1 completely removed from password storage:
   - No new passwords are hashed with sha1()
   - All password_hash() calls use PASSWORD_DEFAULT (bcrypt)

2. Migration logic works:
   - SHA1 hashes detected by strlen === 40
   - Successful SHA1 login triggers automatic migration to bcrypt
   - Bcrypt hashes verified with password_verify()

3. Timing-attack resistance:
   - Using password_verify() (timing-attack safe by design)
   - Not using loose equality (==) for password comparison

4. Future-proof:
   - password_needs_rehash() checks for algorithm/cost upgrades
   - PASSWORD_DEFAULT allows PHP to change algorithm in future
</verification>

<success_criteria>
- [ ] application/controllers/Auth.php uses password_hash() with PASSWORD_DEFAULT for all new passwords
- [ ] Login method detects SHA1 hashes (strlen === 40) and migrates them to bcrypt on successful login
- [ ] Login method uses password_verify() for bcrypt password verification
- [ ] password_needs_rehash() called to upgrade hashes when algorithm/cost changes
- [ ] User_model has update_password($id_user, $hash) method
- [ ] No sha1() calls remain for password storage (only for migration verification)
- [ ] All password verification is timing-attack resistant
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup--and--configuration/01-02-SUMMARY.md`
</output>
