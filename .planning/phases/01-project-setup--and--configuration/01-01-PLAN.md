---
phase: 01-project-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - application/config/config.php
  - application/config/development/database.php
  - application/config/production/database.php
  - composer.lock
autonomous: true

must_haves:
  truths:
    - "Developer can access application at http://localhost with correct base URL"
    - "Database credentials are separated by environment (dev vs production)"
    - "Composer dependencies are version-locked for reproducible builds"
  artifacts:
    - path: "application/config/config.php"
      provides: "Dynamic base URL configuration"
      contains: "base_url.*HTTP_HOST"
    - path: "application/config/development/database.php"
      provides: "Development database credentials"
      contains: "hostname.*username.*password.*database"
    - path: "application/config/production/database.php"
      provides: "Production database credentials"
      contains: "getenv"
    - path: "composer.lock"
      provides: "Locked dependency versions"
      min_lines: 10
  key_links:
    - from: "application/config/config.php"
      to: "HTTP_HOST detection"
      via: "dynamic base_url assignment"
      pattern: "\\$_SERVER\\['HTTP_HOST'\\]"
    - from: "application/config/development/database.php"
      to: "mysqli database connection"
      via: "database configuration array"
      pattern: "\\$db\\['default'\\]"
---

<objective>
Configure environment-specific settings and lock dependencies for reproducible builds.

Purpose: Establishes correct base URL for asset loading and routing, separates development and production database credentials following CodeIgniter 3 environment folder conventions, and generates composer.lock to prevent dependency version drift.

Output: Configured base URL with dynamic detection, environment-specific database configurations in application/config/{environment}/ folders, and committed composer.lock file.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup--and--configuration/01-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure dynamic base URL</name>
  <files>application/config/config.php</files>
  <action>
Update application/config/config.php to use dynamic base URL detection instead of empty string. Replace line 26 ($config["base_url"] = "";) with the dynamic detection pattern from RESEARCH.md Pattern 2:

```php
// Dynamic base URL detection
$allowed_domains = array('localhost', 'localhost:8080', 'localhost:3000');
$default_domain  = 'localhost';

if (isset($_SERVER['HTTP_HOST']) && in_array($_SERVER['HTTP_HOST'], $allowed_domains, TRUE)) {
    $domain = $_SERVER['HTTP_HOST'];
} else {
    $domain = $default_domain;
}

if (isset($_SERVER['HTTPS']) && !empty($_SERVER['HTTPS'])) {
    $config['base_url'] = 'https://'.$domain;
} else {
    $config['base_url'] = 'http://'.$domain;
}
```

Preserve existing timezone setting (Asia/Makassar) on line 27. Do NOT use hardcoded base_url - this causes issues when deploying to different environments.
  </action>
  <verify>
Run: `php -r "define('BASEPATH', 'test'); \$_SERVER['HTTP_HOST'] = 'localhost'; include 'application/config/config.php'; echo \$config['base_url'];"`

Expected output: `http://localhost` (no trailing slash, dynamically detected)
  </verify>
  <done>
application/config/config.php contains dynamic base_url detection using $_SERVER['HTTP_HOST'], handles both HTTP and HTTPS, includes localhost variations in allowed_domains array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create environment-specific database configurations</name>
  <files>
application/config/development/database.php
application/config/production/database.php
  </files>
  <action>
Create CodeIgniter 3 environment-specific database configurations following Pattern 3 from RESEARCH.md.

1. Create application/config/development/ directory if it doesn't exist
2. Create application/config/production/ directory if it doesn't exist

3. Create application/config/development/database.php with hardcoded local credentials:
```php
<?php
defined('BASEPATH') OR exit('No direct script access allowed');

$active_group = 'default';
$query_builder = TRUE;

$db['default'] = array(
    'dsn'   => '',
    'hostname' => 'localhost',
    'username' => 'root',
    'password' => '',
    'database' => 'siat_db',
    'dbdriver' => 'mysqli',
    'dbprefix' => '',
    'pconnect' => FALSE,
    'db_debug' => TRUE,  // Show errors in development
    'cache_on' => FALSE,
    'cachedir' => '',
    'char_set' => 'utf8mb4',
    'dbcollat' => 'utf8mb4_unicode_ci',
    'swap_pre' => '',
    'encrypt' => FALSE,
    'compress' => FALSE,
    'stricton' => FALSE,
    'failover' => array(),
    'save_queries' => TRUE  // Debug queries in development
);
```

4. Create application/config/production/database.php using environment variables:
```php
<?php
defined('BASEPATH') OR exit('No direct script access allowed');

$active_group = 'default';
$query_builder = TRUE;

$db['default'] = array(
    'dsn'   => '',
    'hostname' => getenv('DB_HOST') ?: 'localhost',
    'username' => getenv('DB_USER') ?: '',
    'password' => getenv('DB_PASS') ?: '',
    'database' => getenv('DB_NAME') ?: '',
    'dbdriver' => 'mysqli',
    'dbprefix' => '',
    'pconnect' => FALSE,
    'db_debug' => FALSE,  // Hide errors in production
    'cache_on' => FALSE,
    'cachedir' => '',
    'char_set' => 'utf8mb4',
    'dbcollat' => 'utf8mb4_unicode_ci',
    'swap_pre' => '',
    'encrypt' => FALSE,
    'compress' => FALSE,
    'stricton' => FALSE,
    'failover' => array(),
    'save_queries' => FALSE  // Disable query saving in production
);
```

Note: Use utf8mb4 (not utf8) for full Unicode support including emoji. Production uses getenv() to read from environment variables (set via Apache SetEnv or .htaccess).
  </action>
  <verify>
Check files exist:
```bash
ls -la application/config/development/database.php
ls -la application/config/production/database.php
```

Verify development config has hardcoded credentials and db_debug = TRUE:
```bash
grep -E "(username|password|database|db_debug)" application/config/development/database.php
```

Verify production config uses getenv() and db_debug = FALSE:
```bash
grep -E "(getenv|db_debug)" application/config/production/database.php
```
  </verify>
  <done>
application/config/development/database.php exists with hardcoded local credentials (username: root, password: empty, database: siat_db, db_debug: TRUE). application/config/production/database.php exists using getenv() for all credentials (db_debug: FALSE). Both use utf8mb4 character set and mysqli driver.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate composer.lock for reproducible builds</name>
  <files>composer.lock</files>
  <action>
Generate composer.lock file from existing composer.json to lock dependency versions.

Run: `composer install`

This creates composer.lock with exact versions of all dependencies (including transitive dependencies). The lock file ensures that all environments (development, staging, production) install identical dependency versions, preventing "works on my machine" issues.

Do NOT run `composer update` - that would change dependency versions. Use `composer install` which generates the lock file from composer.json constraints.
  </action>
  <verify>
Check composer.lock was created and is valid:
```bash
ls -lh composer.lock
composer validate
```

Expected: composer.lock exists (file size > 1KB), `composer validate` shows "composer.json and composer.lock are valid".
  </verify>
  <done>
composer.lock file exists in project root with locked versions of all dependencies. File size is greater than 1KB. `composer validate` confirms composer.json and composer.lock are in sync and valid.
  </done>
</task>

</tasks>

<verification>
Overall phase checks after all tasks complete:

1. Base URL configuration works:
   - Visit http://localhost in browser
   - Inspect page source: all asset links (CSS/JS) should use http://localhost as base
   - No broken asset paths or 404s for CSS/JS files

2. Environment-specific database configs exist:
   - application/config/development/database.php contains hardcoded local credentials
   - application/config/production/database.php uses getenv() for credentials
   - Both files use utf8mb4 and mysqli driver

3. Composer lock file valid:
   - composer.lock exists and is committed to git
   - `composer validate` passes
   - File is not empty (>1KB size)
</verification>

<success_criteria>
- [ ] application/config/config.php has dynamic base_url detection using $_SERVER['HTTP_HOST']
- [ ] application/config/development/database.php exists with hardcoded credentials (root/empty/siat_db)
- [ ] application/config/production/database.php exists using getenv() for all credentials
- [ ] composer.lock file exists and is valid (composer validate passes)
- [ ] All configuration files follow CodeIgniter 3 conventions
- [ ] No hardcoded production credentials in git-tracked files
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup--and--configuration/01-01-SUMMARY.md`
</output>
