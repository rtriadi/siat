---
phase: 02-authentication--and--user-management
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - application/controllers/User.php
  - application/views/user/import_form.php
  - application/views/user/import_preview.php
  - application/models/User_model.php
  - composer.json
  - composer.lock
autonomous: true

must_haves:
  truths:
    - "Admin can download the employee import template"
    - "Admin can upload Excel and preview rows before import"
    - "Imported employees are created with username/password=NIP and must_change_password=1"
  artifacts:
    - path: application/controllers/User.php
      provides: "Admin-only employee import + template download"
    - path: application/views/user/import_form.php
      provides: "Upload form for employee import"
    - path: application/views/user/import_preview.php
      provides: "Preview of parsed Excel rows"
    - path: application/models/User_model.php
      provides: "Bulk insert helpers for pegawai"
  key_links:
    - from: application/controllers/User.php
      to: application/models/User_model.php
      via: "insert_pegawai_batch"
      pattern: "insert_pegawai_batch\("
    - from: application/controllers/User.php
      to: "PhpSpreadsheet"
      via: "Reader/Writer"
      pattern: "PhpSpreadsheet\\"
---

<objective>
Implement Excel-based employee import with preview and template download for admins.

Purpose: Complete AUTH-02, AUTH-03, AUTH-06 with validated bulk onboarding.
Output: Admin import UI, preview flow, template download, and bulk insert logic.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication--and--user-management/02-RESEARCH.md
@application/models/User_model.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin import controller and views</name>
  <files>application/controllers/User.php, application/views/user/import_form.php, application/views/user/import_preview.php, composer.json, composer.lock</files>
  <action>
If PhpSpreadsheet is not installed, add it via composer. Create User controller (admin-only) with methods: `import()` (upload form), `import_preview()` (handle upload + parse Excel + validation + preview), `import_commit()` (confirm insert from preview), and `download_template()` (generate XLSX with headers NIP, Nama, Unit and download). Use CI Upload library with allowed_types xlsx|xls and size limits. In preview, skip header row, trim values, validate required columns, detect duplicates within file and against DB, and store valid rows in session for commit. Build upload form and preview views with error display and confirm button.
  </action>
  <verify>php -l application/controllers/User.php && php -l application/views/user/import_form.php && php -l application/views/user/import_preview.php</verify>
  <done>Admin can upload Excel, see preview, and download template</done>
</task>

<task type="auto">
  <name>Task 2: Implement bulk insert helpers for pegawai accounts</name>
  <files>application/models/User_model.php</files>
  <action>
Add model methods: `get_existing_nips($nips)` (returns existing NIP/username), `insert_pegawai_batch($rows)` using transaction + insert_batch. For each row, set `username` = NIP, `password` = password_hash(NIP, PASSWORD_DEFAULT), `nama`, `nip`, `unit`, `level` = 2, `must_change_password` = 1, `is_active` = 1. Return counts for success/fail and surface DB errors to controller for feedback.
  </action>
  <verify>php -l application/models/User_model.php</verify>
  <done>Validated rows can be inserted in bulk with default credentials and must_change_password flag</done>
</task>

</tasks>

<verification>
- php -l on new/modified PHP files passes
- Composer dependency includes phpoffice/phpspreadsheet if previously missing
</verification>

<success_criteria>
- Admin can download employee import template
- Admin can preview Excel data and confirm import
- Imported pegawai accounts are created with username/password=NIP and must_change_password=1
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication--and--user-management/02-04-SUMMARY.md`
</output>
