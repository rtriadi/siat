---
phase: 02-authentication--and--user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/schema.sql
  - database/patches/02-auth.sql
  - application/models/User_model.php
  - application/controllers/Auth.php
  - application/helpers/fungsi_helper.php
  - application/libraries/Fungsi.php
autonomous: true

must_haves:
  truths:
    - "Admin and pegawai can log in and reach role-appropriate pages"
    - "Session identifies the logged-in user and their role"
    - "Access to admin or pegawai routes is blocked for the wrong role"
  artifacts:
    - path: database/schema.sql
      provides: "User table columns: unit, must_change_password"
      contains: "must_change_password"
    - path: database/patches/02-auth.sql
      provides: "ALTER TABLE user add unit and must_change_password"
    - path: application/controllers/Auth.php
      provides: "Login sets session id_user, level, must_change_password"
      exports: ["login", "logout"]
    - path: application/helpers/fungsi_helper.php
      provides: "check_admin and check_pegawai guards"
    - path: application/models/User_model.php
      provides: "User lookup and login metadata update"
  key_links:
    - from: application/controllers/Auth.php
      to: application/models/User_model.php
      via: "get_by_username + update_login_meta"
      pattern: "get_by_username\(|update_login_meta\("
    - from: application/helpers/fungsi_helper.php
      to: session.level
      via: "check_admin/check_pegawai"
      pattern: "userdata\('level'\)"
---

<objective>
Harden core auth session state and role guards, with schema support for employee unit and default-password tracking.

Purpose: Establish stable authentication primitives before UI flows and bulk import.
Output: Updated schema + auth/session wiring + role guard helpers.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication--and--user-management/02-RESEARCH.md
@database/schema.sql
@application/controllers/Auth.php
@application/models/User_model.php
@application/helpers/fungsi_helper.php
@application/libraries/Fungsi.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit + must_change_password columns with patch script</name>
  <files>database/schema.sql, database/patches/02-auth.sql</files>
  <action>
Add `unit` (VARCHAR(100), nullable) and `must_change_password` (TINYINT(1) default 0) to the `user` table definition in schema.sql. Create `database/patches/02-auth.sql` with idempotent ALTER TABLE statements to add both columns to existing databases and set default values for existing rows. Keep admin row default `must_change_password=0`.
  </action>
  <verify>mysql -u root -p siat_db < database/patches/02-auth.sql && mysql -u root -p -e "DESCRIBE user" siat_db</verify>
  <done>schema.sql and patch script define unit + must_change_password columns for user records</done>
</task>

<task type="auto">
  <name>Task 2: Extend user model and session utility</name>
  <files>application/models/User_model.php, application/libraries/Fungsi.php</files>
  <action>
In User_model, add methods: `get_by_id($id_user)`, `update_login_meta($id_user, $timestamp)` (sets last_login), and `set_must_change_password($id_user, $flag)`. Keep `get_by_username` returning row_array including `level`, `unit`, and `must_change_password`. In Fungsi library, update `user_login()` to query from `user` table using Query Builder and current session `id_user`.
  </action>
  <verify>php -l application/models/User_model.php && php -l application/libraries/Fungsi.php</verify>
  <done>User_model supports login metadata and Fungsi reads current user from user table</done>
</task>

<task type="auto">
  <name>Task 3: Update login flow and role guards</name>
  <files>application/controllers/Auth.php, application/helpers/fungsi_helper.php</files>
  <action>
In Auth::login, use Form Validation for required username/password. Reject inactive users (`is_active=0`). On success, set session data: `id_user`, `username`, `level`, `must_change_password`. Call `update_login_meta` with current timestamp. Keep bcrypt migration logic intact. In fungsi_helper, add `check_admin()` and `check_pegawai()` based on session `level` (Admin=1, Pegawai=2). Keep `check_not_login()` unchanged.
  </action>
  <verify>php -l application/controllers/Auth.php && php -l application/helpers/fungsi_helper.php</verify>
  <done>Login sets role-aware session fields and helper guards exist for admin/pegawai routes</done>
</task>

</tasks>

<verification>
- php -l on modified PHP files passes
- user table has unit + must_change_password columns after applying patch
</verification>

<success_criteria>
- User records can store unit and must_change_password flags
- Successful login sets session id_user/level and updates last_login
- check_admin/check_pegawai helper guards are available
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication--and--user-management/02-01-SUMMARY.md`
</output>
