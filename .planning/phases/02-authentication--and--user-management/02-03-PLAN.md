---
phase: 02-authentication--and--user-management
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - application/controllers/Auth.php
  - application/controllers/Pegawai.php
  - application/models/User_model.php
  - application/views/user/change_password.php
  - application/views/pegawai/dashboard.php
autonomous: true

must_haves:
  truths:
    - "Pegawai can change their password"
    - "Pegawai with default NIP password are prompted to change it"
  artifacts:
    - path: application/views/user/change_password.php
      provides: "Password change form"
    - path: application/controllers/Auth.php
      provides: "change_password handler with validation"
  key_links:
    - from: application/controllers/Auth.php
      to: application/models/User_model.php
      via: "update_password + set_must_change_password"
      pattern: "update_password\(|set_must_change_password\("
    - from: application/controllers/Pegawai.php
      to: application/controllers/Auth.php
      via: "redirect when must_change_password=1"
      pattern: "change_password"
---

<objective>
Enable password changes and enforce reminders for pegawai using default NIP passwords.

Purpose: Complete AUTH-04 and AUTH-05 while enforcing secure credential updates.
Output: Password change form + enforcement logic + reminder messaging.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@application/controllers/Auth.php
@application/controllers/Pegawai.php
@application/models/User_model.php
@application/views/pegawai/dashboard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add change-password form and handler</name>
  <files>application/controllers/Auth.php, application/models/User_model.php, application/views/user/change_password.php</files>
  <action>
Add `change_password()` in Auth with GET/POST handling. Use Form Validation rules: current_password required, new_password min_length[8], confirm_password matches new_password. Verify current password with `password_verify`, update hash using `password_hash(PASSWORD_DEFAULT)` via User_model `update_password($id_user, $hash)`, clear `must_change_password` via User_model, then redirect to pegawai dashboard with success flash. Restrict access to logged-in pegawai only. If User_model lacks `update_password`, implement it to update password hash for a user id.
  </action>
  <verify>php -l application/controllers/Auth.php && php -l application/views/user/change_password.php</verify>
  <done>Pegawai can submit change password form and update their password hash</done>
</task>

<task type="auto">
  <name>Task 2: Enforce reminder and redirect for default password</name>
  <files>application/controllers/Auth.php, application/controllers/Pegawai.php, application/views/pegawai/dashboard.php</files>
  <action>
After successful login, if `must_change_password=1` for pegawai, redirect to `auth/change_password` and set warning flash. In Pegawai controller, if session `must_change_password=1`, redirect to change password to block dashboard access. In pegawai dashboard view, render reminder banner when `must_change_password` is set (fallback for cases that reach dashboard).
  </action>
  <verify>php -l application/controllers/Auth.php && php -l application/controllers/Pegawai.php && php -l application/views/pegawai/dashboard.php</verify>
  <done>Default-password pegawai are redirected to change password and see reminder text</done>
</task>

</tasks>

<verification>
- php -l on modified PHP files passes
- change_password route exists and updates must_change_password to 0
</verification>

<success_criteria>
- Pegawai can change their password and login with the new password
- Pegawai with default NIP password are forced to change it
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication--and--user-management/02-03-SUMMARY.md`
</output>
